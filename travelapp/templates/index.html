{% extends "base.html" %}

{% block content %}
<div class="grid-container">
    <!-- ì¤‘ì•™: GPT ìƒì„± ì¼ì • ì¶œë ¥ -->
    <div class="center-panel">
        <h3>ğŸ“… ì—¬í–‰ ì¼ì •</h3>
        <div class="itinerary-box">
            {{ result | safe }} <!-- HTMLë¡œ ë³€í™˜ëœ ì¼ì • ë§ˆí¬ë‹¤ìš´ ì¶œë ¥ -->
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì¹´ì¹´ì˜¤ ì§€ë„ -->
    <div class="right-panel">
        <h3>ğŸ—ºï¸ ì§€ë„</h3>
        <div id="map" style="width: 100%; height: 400px;"></div>
    </div>
</div>

<!-- ì¥ì†Œ ë§í¬ ìŠ¤íƒ€ì¼ -->
<style>
.place-link {
    color: #007bff;            /* íŒŒë€ìƒ‰ ë§í¬ */
    cursor: pointer;
    text-decoration: underline;
}
.place-link:hover {
    background-color: #eaf4ff; /* í˜¸ë²„ ì‹œ ë°°ê²½ */
}
</style>

<!-- Kakao Maps JavaScript SDK ë¡œë“œ -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=false"></script>
<script>
// SDK ë¡œë“œ í›„ ì‹¤í–‰
kakao.maps.load(function () {
    // í˜„ì¬ ì—´ë¦° InfoWindow ì €ì¥ìš© ë³€ìˆ˜
    let currentInfoWindow = null;

    const mapContainer = document.getElementById('map');
    // ì´ˆê¸° ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ
    const center = new kakao.maps.LatLng({{ center_lat }}, {{ center_lng }});
    const map = new kakao.maps.Map(mapContainer, { center: center, level: 6 });

    // Flaskì—ì„œ ì „ë‹¬í•œ ë§ˆì»¤ ë°ì´í„°
    const markerData = {{ markers | tojson | safe }};
    const markerDict = {};

    // ê° ë§ˆì»¤ ìƒì„±
    markerData.forEach(m => {
        const pos = new kakao.maps.LatLng(m.lat, m.lng);
        const marker = new kakao.maps.Marker({ map, position: pos });
        // InfoWindow ë‚´ìš©: ë‚ ì§œ, ì‹œê°„, ì„¤ëª… í¬í•¨
        const info = new kakao.maps.InfoWindow({
            content: `
                <div style="padding:6px 10px; font-size:13px;">
                    <b>${m.day} ${m.time}</b><br>
                    ğŸ“ <b>${m.name}</b><br>
                    ğŸ“ ${m.desc}
                </div>`
        });
        // ë§ˆì»¤ í´ë¦­ ì‹œ InfoWindow ì—´ê¸°
        kakao.maps.event.addListener(marker, 'click', () =>{
            // ì´ì „ InfoWindow ë‹«ê¸°
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
            // ìƒˆ InfoWindow ì—´ê¸° & ì €ì¥
            info.open(map, marker);
            currentInfoWindow = info;
        });

        markerDict[m.name] = { marker, info, pos };
    });
    // ì¼ì • ë‚´ ì¥ì†Œ í´ë¦­ ì‹œ â†’ ì§€ë„ ì´ë™ + InfoWindow í‘œì‹œ
    document.querySelectorAll('.place-link').forEach(el => {
        el.addEventListener('click', () => {
            const name = el.dataset.name;
            const data = markerDict[name];
            if (!data) return;

            // ì´ì „ InfoWindow ë‹«ê¸°
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
            // ì§€ë„ ì„¼í„° ì´ë™ + ìƒˆ InfoWindow ì—´ê¸° & ì €ì¥
            map.setCenter(data.pos);
            data.info.open(map, data.marker);
            currentInfoWindow = data.info;
        });
    });
});
</script>

{% endblock %}