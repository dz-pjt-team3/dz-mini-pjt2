{% extends "base.html" %}

{% block title %}ğŸ“‹ ì¼ì • ë³´ê¸°{% endblock %}

{% block content %}
<header class="site-header">
  <h1>AI ì—¬í–‰ ì¼ì • ìƒì„±ê¸°</h1>
</header>

<div class="grid-container">
  <!-- ì¤‘ì•™: GPT ìƒì„± ì¼ì • ì¶œë ¥ -->
  <div class="center-panel">
    <h3>ì—¬í–‰ ì¼ì •</h3>
    <div class="itinerary-box">
      {{ result | safe }}
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½: ì¹´ì¹´ì˜¤ ì§€ë„ -->
  <div class="right-panel">
    <h3>ì§€ë„</h3>
    <div id="map" style="width: 100%; height: 400px;"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  .place-link {
    color: #007bff;
    cursor: pointer;
    text-decoration: underline;
  }
  .place-link:hover {
    background-color: #eaf4ff;
  }
  .itinerary-box {
    height: 400px;      /* ì§€ë„ ë†’ì´ì™€ ë™ì¼í•˜ê²Œ */
    overflow-y: auto;   /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
    padding-right: 10px;/* ìŠ¤í¬ë¡¤ë°”ì™€ ë‚´ìš© ê²¹ì¹¨ ë°©ì§€ ì—¬ë°± */
  }
</style>

<!-- Kakao Maps JavaScript SDK -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}&autoload=false"></script>
<script>
// Kakao Maps API ë¡œë“œ í›„ ì‹¤í–‰
kakao.maps.load(function () {
  let currentInfoWindow = null;

  // 1) ì§€ë„ ìƒì„±
  const mapContainer = document.getElementById('map');
  const center = new kakao.maps.LatLng({{ center_lat }}, {{ center_lng }});
  const map = new kakao.maps.Map(mapContainer, { center: center, level: 6 });

  // 2) ë§ˆì»¤ ë°ì´í„° ë° ë”•ì…”ë„ˆë¦¬
  const markerData = {{ markers | tojson | safe }};
  const markerDict = {};

  // 3) ë§ˆì»¤ ìƒì„± ë° í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
  markerData.forEach(m => {
    const pos = new kakao.maps.LatLng(m.lat, m.lng);
    const marker = new kakao.maps.Marker({ map, position: pos });
    const info = new kakao.maps.InfoWindow({
      content: `
        <div style="display: inline-block; white-space: nowrap; padding:6px 10px; font-size:13px; font-family:'Malgun Gothic';">
          <b>${m.day} ${m.time}</b><br>
          <b>ğŸ ${m.name}</b><br>
        </div>
        `,
      removable: true
    });

    // ë§ˆì»¤ í´ë¦­ ì‹œ InfoWindow í‘œì‹œ
    kakao.maps.event.addListener(marker, 'click', () => {
      if (currentInfoWindow) currentInfoWindow.close();
      info.open(map, marker);
      currentInfoWindow = info;
    });

    markerDict[m.name] = { marker, info, pos };
  });

  // 4) ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ ë§ˆì»¤ë¡œ ì´ë™ ë° InfoWindow ì˜¤í”ˆ
  document.querySelectorAll('.place-link').forEach(el => {
    el.addEventListener('click', () => {
      const name = el.dataset.name;
      const data = markerDict[name];
      if (!data) return;

      if (currentInfoWindow) currentInfoWindow.close();
      map.setCenter(data.pos);
      data.info.open(map, data.marker);
      currentInfoWindow = data.info;
    });
  });
// 5) ë‹¤ì¤‘ ê²½ìœ ì§€ Polyline í‘œì‹œ
    const routeData = {{ route_data | tojson | safe }};
    if (routeData.routes && routeData.routes.length > 0) {
      const sections = routeData.routes[0].sections;
      const linePath = [];

      sections.forEach(sec => {
        sec.roads.forEach(rd => {
          const verts = rd.vertexes;  // [ê²½ë„, ìœ„ë„, ê²½ë„, ìœ„ë„, â€¦] í˜•íƒœ :contentReference[oaicite:0]{index=0}
          for (let i = 0; i < verts.length; i += 2) {
            const lng = verts[i], lat = verts[i+1];
            linePath.push(new kakao.maps.LatLng(lat, lng));
          }
        });
      });

      // Polyline ìƒì„±
      const polyline = new kakao.maps.Polyline({
        path: linePath,
        strokeWeight: 4,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8
      });
      polyline.setMap(map);

      // ì§€ë„ ë²”ìœ„ ì¬ì„¤ì •
      const bounds = new kakao.maps.LatLngBounds();
      linePath.forEach(latlng => bounds.extend(latlng));
      map.setBounds(bounds);
    }
  });
</script>
{% endblock %}
